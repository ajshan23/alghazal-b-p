{"version":3,"file":"expenseController.js","sourceRoot":"","sources":["../../src/controllers/expenseController.ts"],"names":[],"mappings":"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","sourcesContent":["import { Request, Response } from \"express\";\r\nimport { asyncHandler } from \"../utils/asyncHandler\";\r\nimport { ApiResponse } from \"../utils/apiHandlerHelpers\";\r\nimport { ApiError } from \"../utils/apiHandlerHelpers\";\r\nimport { Expense } from \"../models/expenseModel\";\r\nimport { IProject, Project } from \"../models/projectModel\";\r\nimport { Attendance } from \"../models/attendanceModel\";\r\nimport { Types } from \"mongoose\";\r\nimport { deleteFileFromS3, uploadExpenseDocument } from \"../utils/uploadConf\";\r\nimport { Quotation } from \"../models/quotationModel\";\r\nimport puppeteer from \"puppeteer\";\r\n\r\ninterface PopulatedUser {\r\n  _id: Types.ObjectId;\r\n  firstName: string;\r\n  lastName: string;\r\n  profileImage?: string;\r\n  salary?: number;\r\n}\r\n\r\ninterface MaterialInput {\r\n  description: string;\r\n  date?: Date;\r\n  invoiceNo: string;\r\n  amount: number;\r\n  supplierName?: string;\r\n  supplierMobile?: string;\r\n  supplierEmail?: string;\r\n  documentUrl?: string;\r\n  documentKey?: string;\r\n}\r\n\r\ninterface WorkerLabor {\r\n  user: Types.ObjectId;\r\n  firstName: string;\r\n  lastName: string;\r\n  profileImage?: string;\r\n  daysPresent: number;\r\n  dailySalary: number;\r\n  totalSalary: number;\r\n}\r\n\r\ninterface DriverLabor {\r\n  user: Types.ObjectId;\r\n  firstName: string;\r\n  lastName: string;\r\n  profileImage?: string;\r\n  daysPresent: number;\r\n  dailySalary: number;\r\n  totalSalary: number;\r\n}\r\n\r\nconst calculateLaborDetails = async (projectId: string) => {\r\n  const project = await Project.findById(projectId)\r\n    .populate<{ assignedWorkers: PopulatedUser[] }>(\r\n      \"assignedWorkers\",\r\n      \"firstName lastName profileImage salary\"\r\n    )\r\n    .populate<{ assignedDriver: PopulatedUser }>(\r\n      \"assignedDriver\",\r\n      \"firstName lastName profileImage salary\"\r\n    );\r\n\r\n  if (!project) {\r\n    throw new ApiError(404, \"Project not found\");\r\n  }\r\n\r\n  const workersToProcess = project.assignedWorkers || [];\r\n  const workerIds = workersToProcess.map((worker) => worker._id);\r\n\r\n  const workerAttendanceRecords = await Attendance.find({\r\n    project: projectId,\r\n    present: true,\r\n    user: { $in: workerIds },\r\n  }).populate<{ user: PopulatedUser }>(\"user\", \"firstName lastName\");\r\n\r\n  const workerDaysMap = new Map<string, number>();\r\n  workerAttendanceRecords.forEach((record) => {\r\n    const userIdStr = record.user._id.toString();\r\n    workerDaysMap.set(userIdStr, (workerDaysMap.get(userIdStr) || 0) + 1);\r\n  });\r\n\r\n  const projectAttendanceDates = await Attendance.aggregate([\r\n    {\r\n      $match: {\r\n        project: new Types.ObjectId(projectId),\r\n        present: true,\r\n      },\r\n    },\r\n    {\r\n      $group: {\r\n        _id: {\r\n          $dateToString: { format: \"%Y-%m-%d\", date: \"$date\" },\r\n        },\r\n      },\r\n    },\r\n    {\r\n      $count: \"uniqueDates\",\r\n    },\r\n  ]);\r\n\r\n  const driverDaysPresent = projectAttendanceDates[0]?.uniqueDates || 0;\r\n\r\n  const workers = workersToProcess.map((worker) => ({\r\n    user: worker._id,\r\n    firstName: worker.firstName,\r\n    lastName: worker.lastName,\r\n    profileImage: worker.profileImage,\r\n    daysPresent: workerDaysMap.get(worker._id.toString()) || 0,\r\n    dailySalary: worker.salary || 0,\r\n    totalSalary:\r\n      (workerDaysMap.get(worker._id.toString()) || 0) * (worker.salary || 0),\r\n  }));\r\n\r\n  const driver = project.assignedDriver\r\n    ? {\r\n        user: project.assignedDriver._id,\r\n        firstName: project.assignedDriver.firstName,\r\n        lastName: project.assignedDriver.lastName,\r\n        profileImage: project.assignedDriver.profileImage,\r\n        daysPresent: driverDaysPresent,\r\n        dailySalary: project.assignedDriver.salary || 0,\r\n        totalSalary: driverDaysPresent * (project.assignedDriver.salary || 0),\r\n      }\r\n    : {\r\n        user: new Types.ObjectId(),\r\n        firstName: \"No\",\r\n        lastName: \"Driver\",\r\n        daysPresent: 0,\r\n        dailySalary: 0,\r\n        totalSalary: 0,\r\n      };\r\n\r\n  const totalLaborCost =\r\n    workers.reduce((sum, worker) => sum + worker.totalSalary, 0) +\r\n    driver.totalSalary;\r\n\r\n  return {\r\n    workers,\r\n    driver,\r\n    totalLaborCost,\r\n  };\r\n};\r\n\r\nexport const getProjectLaborData = asyncHandler(\r\n  async (req: Request, res: Response) => {\r\n    const { projectId } = req.params;\r\n    try {\r\n      const laborData = await calculateLaborDetails(projectId);\r\n      res\r\n        .status(200)\r\n        .json(\r\n          new ApiResponse(200, laborData, \"Labor data fetched successfully\")\r\n        );\r\n    } catch (error) {\r\n      throw new ApiError(500, \"Failed to fetch labor data\");\r\n    }\r\n  }\r\n);\r\n\r\nexport const createExpense = asyncHandler(\r\n  async (req: Request, res: Response) => {\r\n    const { projectId } = req.params;\r\n    const userId = req.user?.userId;\r\n\r\n    if (!userId) {\r\n      throw new ApiError(401, \"Unauthorized\");\r\n    }\r\n\r\n    // Validate materials field\r\n    if (!req.body.materials) {\r\n      throw new ApiError(400, \"Materials data is required\");\r\n    }\r\n\r\n    let materials: MaterialInput[];\r\n    try {\r\n      materials =\r\n        typeof req.body.materials === \"string\"\r\n          ? JSON.parse(req.body.materials)\r\n          : req.body.materials;\r\n    } catch (err) {\r\n      throw new ApiError(400, \"Invalid materials JSON format\");\r\n    }\r\n\r\n    // Get uploaded files\r\n    const files = req.files as\r\n      | { [fieldname: string]: Express.Multer.File[] }\r\n      | undefined;\r\n    const fileList = files?.files ? [...files.files] : [];\r\n\r\n    try {\r\n      const laborDetails = await calculateLaborDetails(projectId);\r\n\r\n      // Create file map with index-based matching\r\n      const fileMap = new Map<number, Express.Multer.File>();\r\n      fileList.forEach((file) => {\r\n        const indexMatch = file.originalname.match(/file-(\\d+)/);\r\n        if (indexMatch) {\r\n          fileMap.set(parseInt(indexMatch[1], 10), file);\r\n        }\r\n      });\r\n\r\n      // Process materials with error handling\r\n      const processedMaterials = await Promise.all(\r\n        materials.map(async (material, index) => {\r\n          const materialData: MaterialInput = {\r\n            description: material.description,\r\n            date: material.date ? new Date(material.date) : new Date(),\r\n            invoiceNo: material.invoiceNo,\r\n            amount: Number(material.amount),\r\n            supplierName: material.supplierName,\r\n            supplierMobile: material.supplierMobile,\r\n            supplierEmail: material.supplierEmail,\r\n          };\r\n\r\n          // Handle file upload if exists for this index\r\n          if (fileMap.has(index)) {\r\n            try {\r\n              const uploadResult = await uploadExpenseDocument(\r\n                fileMap.get(index)!\r\n              );\r\n              if (!uploadResult.success) {\r\n                console.error(`File upload failed for item ${index + 1}`);\r\n                return materialData;\r\n              }\r\n              return {\r\n                ...materialData,\r\n                documentUrl: uploadResult.uploadData?.url,\r\n                documentKey: uploadResult.uploadData?.key,\r\n              };\r\n            } catch (uploadError) {\r\n              console.error(\r\n                `File upload error for material ${index}:`,\r\n                uploadError\r\n              );\r\n              return materialData;\r\n            }\r\n          }\r\n          return materialData;\r\n        })\r\n      );\r\n\r\n      // Create expense record\r\n      const expense = await Expense.create({\r\n        project: projectId,\r\n        materials: processedMaterials,\r\n        laborDetails,\r\n        createdBy: new Types.ObjectId(userId),\r\n      });\r\n\r\n      return res\r\n        .status(201)\r\n        .json(new ApiResponse(201, expense, \"Expense created successfully\"));\r\n    } catch (error: any) {\r\n      console.error(\"Expense creation error:\", error);\r\n      const status = error instanceof ApiError ? error.statusCode : 500;\r\n      const message =\r\n        error instanceof Error ? error.message : \"Failed to create expense\";\r\n      throw new ApiError(status, message);\r\n    }\r\n  }\r\n);\r\nexport const getProjectExpenses = asyncHandler(\r\n  async (req: Request, res: Response) => {\r\n    const { projectId } = req.params;\r\n    const page = parseInt(req.query.page as string) || 1;\r\n    const limit = parseInt(req.query.limit as string) || 10;\r\n    const skip = (page - 1) * limit;\r\n\r\n    const total = await Expense.countDocuments({ project: projectId });\r\n\r\n    const expenses = await Expense.find({ project: projectId })\r\n      .populate(\r\n        \"laborDetails.workers.user\",\r\n        \"firstName lastName profileImage salary\"\r\n      )\r\n      .populate(\r\n        \"laborDetails.driver.user\",\r\n        \"firstName lastName profileImage salary\"\r\n      )\r\n      .populate(\"createdBy\", \"firstName lastName\")\r\n      .skip(skip)\r\n      .limit(limit)\r\n      .sort({ createdAt: -1 });\r\n\r\n    // Add document download URLs to each material in each expense\r\n    const expensesWithDownloadUrls = expenses.map((expense) => ({\r\n      ...expense.toObject(),\r\n      materials: expense.materials.map((material) => ({\r\n        ...material,\r\n        documentDownloadUrl: material.documentKey\r\n          ? `${req.protocol}://${req.get(\"host\")}/api/expenses/document/${\r\n              material.documentKey\r\n            }`\r\n          : null,\r\n      })),\r\n    }));\r\n\r\n    res.status(200).json(\r\n      new ApiResponse(\r\n        200,\r\n        {\r\n          expenses: expensesWithDownloadUrls,\r\n          pagination: {\r\n            total,\r\n            page,\r\n            limit,\r\n            totalPages: Math.ceil(total / limit),\r\n            hasNextPage: page * limit < total,\r\n            hasPreviousPage: page > 1,\r\n          },\r\n        },\r\n        \"Expenses fetched successfully\"\r\n      )\r\n    );\r\n  }\r\n);\r\n\r\nexport const getExpenseById = asyncHandler(\r\n  async (req: Request, res: Response) => {\r\n    const { expenseId } = req.params;\r\n\r\n    const expense = await Expense.findById(expenseId)\r\n      .populate(\r\n        \"laborDetails.workers.user\",\r\n        \"firstName lastName profileImage salary\"\r\n      )\r\n      .populate(\r\n        \"laborDetails.driver.user\",\r\n        \"firstName lastName profileImage salary\"\r\n      )\r\n      .populate(\"createdBy\", \"firstName lastName\")\r\n      .populate(\"project\", \"projectName projectNumber\");\r\n\r\n    if (!expense) {\r\n      throw new ApiError(404, \"Expense not found\");\r\n    }\r\n\r\n    // Add document download URLs to each material\r\n    const expenseWithDownloadUrls = {\r\n      ...expense.toObject(),\r\n      materials: expense.materials.map((material) => ({\r\n        ...material,\r\n        documentDownloadUrl: material.documentKey\r\n          ? `${req.protocol}://${req.get(\"host\")}/api/expenses/document/${\r\n              material.documentKey\r\n            }`\r\n          : null,\r\n      })),\r\n      quotation: await Quotation.findOne({ project: expense.project }).select(\r\n        \"netAmount\"\r\n      ),\r\n    };\r\n\r\n    res\r\n      .status(200)\r\n      .json(\r\n        new ApiResponse(\r\n          200,\r\n          expenseWithDownloadUrls,\r\n          \"Expense fetched successfully\"\r\n        )\r\n      );\r\n  }\r\n);\r\n\r\nexport const updateExpense = asyncHandler(\r\n  async (req: Request, res: Response) => {\r\n    const { expenseId } = req.params;\r\n    const { materials } = req.body as { materials: MaterialInput[] };\r\n    const files = req.files as Express.Multer.File[];\r\n\r\n    if (!materials || !Array.isArray(materials)) {\r\n      throw new ApiError(400, \"Materials array is required\");\r\n    }\r\n\r\n    const existingExpense = await Expense.findById(expenseId);\r\n    if (!existingExpense) {\r\n      throw new ApiError(404, \"Expense not found\");\r\n    }\r\n\r\n    // Check if number of files matches number of materials (1:1 relationship)\r\n    if (files && files.length > 0 && files.length !== materials.length) {\r\n      throw new ApiError(\r\n        400,\r\n        \"Number of documents must match number of material items\"\r\n      );\r\n    }\r\n\r\n    const laborDetails = await calculateLaborDetails(\r\n      existingExpense.project.toString()\r\n    );\r\n    const totalMaterialCost = materials.reduce((sum, m) => sum + m.amount, 0);\r\n\r\n    // Process materials with optional documents\r\n    const processedMaterials = await Promise.all(\r\n      materials.map(async (material, index) => {\r\n        const materialData: any = {\r\n          description: material.description,\r\n          date: material.date || new Date(),\r\n          invoiceNo: material.invoiceNo,\r\n          amount: material.amount,\r\n          supplierName: material.supplierName || \"\",\r\n          supplierMobile: material.supplierMobile || \"\",\r\n          supplierEmail: material.supplierEmail || \"\",\r\n        };\r\n\r\n        // If there's a corresponding file for this material item\r\n        if (files && files[index]) {\r\n          // First delete the old document if it exists\r\n          if (existingExpense.materials[index]?.documentKey) {\r\n            await deleteFileFromS3(\r\n              existingExpense.materials[index].documentKey!\r\n            );\r\n          }\r\n\r\n          // Upload new document\r\n          const uploadResult = await uploadExpenseDocument(files[index]);\r\n          if (!uploadResult.success) {\r\n            throw new ApiError(\r\n              500,\r\n              `Failed to upload document for item ${index + 1}`\r\n            );\r\n          }\r\n          materialData.documentUrl = uploadResult.uploadData?.url;\r\n          materialData.documentKey = uploadResult.uploadData?.key;\r\n        } else if (existingExpense.materials[index]?.documentKey) {\r\n          // Keep existing document if no new file was provided\r\n          materialData.documentUrl =\r\n            existingExpense.materials[index].documentUrl;\r\n          materialData.documentKey =\r\n            existingExpense.materials[index].documentKey;\r\n        }\r\n\r\n        return materialData;\r\n      })\r\n    );\r\n\r\n    const updatedExpense = await Expense.findByIdAndUpdate(\r\n      expenseId,\r\n      {\r\n        materials: processedMaterials,\r\n        laborDetails,\r\n        totalMaterialCost,\r\n        updatedAt: new Date(),\r\n      },\r\n      { new: true }\r\n    )\r\n      .populate(\r\n        \"laborDetails.workers.user\",\r\n        \"firstName lastName profileImage salary\"\r\n      )\r\n      .populate(\r\n        \"laborDetails.driver.user\",\r\n        \"firstName lastName profileImage salary\"\r\n      )\r\n      .populate(\"createdBy\", \"firstName lastName\");\r\n\r\n    res\r\n      .status(200)\r\n      .json(\r\n        new ApiResponse(200, updatedExpense, \"Expense updated successfully\")\r\n      );\r\n  }\r\n);\r\n\r\nexport const deleteExpense = asyncHandler(\r\n  async (req: Request, res: Response) => {\r\n    const { expenseId } = req.params;\r\n\r\n    const expense = await Expense.findById(expenseId);\r\n    if (!expense) {\r\n      throw new ApiError(404, \"Expense not found\");\r\n    }\r\n\r\n    // Delete all associated documents from S3\r\n    await Promise.all(\r\n      expense.materials.map(async (material) => {\r\n        if (material.documentKey) {\r\n          await deleteFileFromS3(material.documentKey);\r\n        }\r\n      })\r\n    );\r\n\r\n    await Expense.findByIdAndDelete(expenseId);\r\n\r\n    res\r\n      .status(200)\r\n      .json(new ApiResponse(200, null, \"Expense deleted successfully\"));\r\n  }\r\n);\r\n\r\nexport const getExpenseSummary = asyncHandler(\r\n  async (req: Request, res: Response) => {\r\n    const { projectId } = req.params;\r\n\r\n    const expenses = await Expense.find({ project: projectId });\r\n\r\n    const summary = {\r\n      totalMaterialCost: expenses.reduce(\r\n        (sum, e) => sum + e.totalMaterialCost,\r\n        0\r\n      ),\r\n      totalLaborCost: expenses.reduce(\r\n        (sum, e) => sum + e.laborDetails.totalLaborCost,\r\n        0\r\n      ),\r\n      workersCost: expenses.reduce(\r\n        (sum, e) =>\r\n          sum +\r\n          e.laborDetails.workers.reduce((wSum, w) => wSum + w.totalSalary, 0),\r\n        0\r\n      ),\r\n      driverCost: expenses.reduce(\r\n        (sum, e) => sum + e.laborDetails.driver.totalSalary,\r\n        0\r\n      ),\r\n      totalExpenses: expenses.reduce(\r\n        (sum, e) => sum + e.totalMaterialCost + e.laborDetails.totalLaborCost,\r\n        0\r\n      ),\r\n    };\r\n\r\n    res\r\n      .status(200)\r\n      .json(\r\n        new ApiResponse(200, summary, \"Expense summary fetched successfully\")\r\n      );\r\n  }\r\n);\r\nexport const generateExpensePdf = asyncHandler(\r\n  async (req: Request, res: Response) => {\r\n    const { id } = req.params;\r\n\r\n    // Fetch expense with all related data\r\n    const expense = await Expense.findById(id)\r\n      .populate<{ project: IProject }>({\r\n        path: \"project\",\r\n        select: \"projectName projectNumber\",\r\n      })\r\n      .populate(\"createdBy\", \"firstName lastName\")\r\n      .populate(\"laborDetails.workers.user\", \"firstName lastName profileImage\")\r\n      .populate(\"laborDetails.driver.user\", \"firstName lastName profileImage\");\r\n\r\n    if (!expense) {\r\n      throw new ApiError(404, \"Expense not found\");\r\n    }\r\n\r\n    // Fetch related quotation for profit calculation\r\n    const quotation = await Quotation.findOne({ project: expense.project });\r\n\r\n    // Format dates\r\n    const formatDate = (dateString: string | Date) => {\r\n      const date = new Date(dateString);\r\n      return date.toLocaleDateString(\"en-GB\", {\r\n        day: \"2-digit\",\r\n        month: \"short\",\r\n        year: \"numeric\",\r\n      });\r\n    };\r\n\r\n    // Calculate totals\r\n    const totalMaterialCost = expense.totalMaterialCost;\r\n    const totalLaborCost = expense.laborDetails.totalLaborCost;\r\n    const totalExpense = totalMaterialCost + totalLaborCost;\r\n    const quotationAmount = quotation?.netAmount || 0;\r\n    const profit = quotationAmount - totalExpense;\r\n    const profitPercentage = quotationAmount\r\n      ? (profit / quotationAmount) * 100\r\n      : 0;\r\n\r\n    // Prepare HTML content with logo\r\n    let htmlContent = `\r\n    <!DOCTYPE html>\r\n    <html>\r\n    <head>\r\n      <meta http-equiv=\"Content-Type\" content=\"text/html; charset=utf-8\" />\r\n      <style type=\"text/css\">\r\n        @page {\r\n          size: A4;\r\n          margin: 1cm;\r\n        }\r\n        body {\r\n          font-family: 'Arial', sans-serif;\r\n          font-size: 10pt;\r\n          line-height: 1.4;\r\n          color: #333;\r\n          margin: 0;\r\n          padding: 0;\r\n        }\r\n        .header {\r\n          text-align: center;\r\n          margin-bottom: 15px;\r\n        }\r\n        .logo {\r\n          height: 70px;\r\n          width: auto;\r\n        }\r\n        .document-title {\r\n          font-size: 14pt;\r\n          font-weight: bold;\r\n          margin: 5px 0;\r\n        }\r\n        .project-info {\r\n          font-size: 11pt;\r\n          margin-bottom: 10px;\r\n        }\r\n        .section {\r\n          margin-bottom: 15px;\r\n          page-break-inside: avoid;\r\n        }\r\n        .section-title {\r\n          font-size: 11pt;\r\n          font-weight: bold;\r\n          padding: 5px 0;\r\n          margin: 10px 0 5px 0;\r\n          border-bottom: 1px solid #ddd;\r\n        }\r\n        table {\r\n          width: 100%;\r\n          border-collapse: collapse;\r\n          margin-bottom: 15px;\r\n          page-break-inside: avoid;\r\n        }\r\n        th {\r\n          background-color: #f5f5f5;\r\n          font-weight: bold;\r\n          padding: 6px 8px;\r\n          text-align: left;\r\n          border: 1px solid #ddd;\r\n        }\r\n        td {\r\n          padding: 6px 8px;\r\n          border: 1px solid #ddd;\r\n          vertical-align: top;\r\n        }\r\n        .total-row {\r\n          font-weight: bold;\r\n        }\r\n        .text-right {\r\n          text-align: right;\r\n        }\r\n        .footer {\r\n          margin-top: 20px;\r\n          font-size: 9pt;\r\n          color: #777;\r\n          text-align: center;\r\n        }\r\n      </style>\r\n    </head>\r\n    <body>\r\n      <div class=\"header\">\r\n        <img class=\"logo\" src=\"https://krishnadas-test-1.s3.ap-south-1.amazonaws.com/alghazal/logo.png\" alt=\"Company Logo\">\r\n        <div class=\"document-title\">EXPENSE REPORT</div>\r\n        <div class=\"project-info\">${\r\n          (expense.project as IProject).projectName\r\n        } (${(expense.project as IProject).projectNumber})</div>\r\n      </div>\r\n\r\n      <div class=\"section\">\r\n        <div class=\"section-title\">MATERIAL EXPENSES</div>\r\n        <table>\r\n          <thead>\r\n            <tr>\r\n              <th width=\"5%\">No.</th>\r\n              <th width=\"40%\">Description</th>\r\n              <th width=\"15%\">Date</th>\r\n              <th width=\"20%\">Invoice No</th>\r\n              <th width=\"20%\" class=\"text-right\">Amount (AED)</th>\r\n            </tr>\r\n          </thead>\r\n          <tbody>\r\n            ${expense.materials\r\n              .map(\r\n                (material, index) => `\r\n              <tr>\r\n                <td>${index + 1}</td>\r\n                <td>${material.description}</td>\r\n                <td>${formatDate(material.date)}</td>\r\n                <td>${material.invoiceNo}</td>\r\n                <td class=\"text-right\">${material.amount.toFixed(2)}</td>\r\n              </tr>\r\n            `\r\n              )\r\n              .join(\"\")}\r\n            <tr class=\"total-row\">\r\n              <td colspan=\"4\">TOTAL MATERIAL COST</td>\r\n              <td class=\"text-right\">${totalMaterialCost.toFixed(2)}</td>\r\n            </tr>\r\n          </tbody>\r\n        </table>\r\n      </div>\r\n\r\n      <div class=\"section\">\r\n        <div class=\"section-title\">LABOR DETAILS</div>\r\n        <table>\r\n          <thead>\r\n            <tr>\r\n              <th width=\"5%\">No.</th>\r\n              <th width=\"65%\">Description</th>\r\n              <th width=\"30%\" class=\"text-right\">Amount (AED)</th>\r\n            </tr>\r\n          </thead>\r\n          <tbody>\r\n            <tr>\r\n              <td>1</td>\r\n              <td>Technicians Expenses</td>\r\n              <td class=\"text-right\">${expense.laborDetails.workers\r\n                .reduce((sum, worker) => sum + worker.totalSalary, 0)\r\n                .toFixed(2)}</td>\r\n            </tr>\r\n            <tr>\r\n              <td>2</td>\r\n              <td>Driver Expenses</td>\r\n              <td class=\"text-right\">${\r\n                expense.laborDetails.driver?.totalSalary.toFixed(2) || \"0.00\"\r\n              }</td>\r\n            </tr>\r\n            <tr class=\"total-row\">\r\n              <td colspan=\"2\">TOTAL LABOR COST</td>\r\n              <td class=\"text-right\">${totalLaborCost.toFixed(2)}</td>\r\n            </tr>\r\n          </tbody>\r\n        </table>\r\n      </div>\r\n\r\n      <div class=\"section\">\r\n        <div class=\"section-title\">OTHER EXPENSES</div>\r\n        <table>\r\n          <thead>\r\n            <tr>\r\n              <th width=\"70%\">Description</th>\r\n              <th width=\"30%\" class=\"text-right\">Amount (AED)</th>\r\n            </tr>\r\n          </thead>\r\n          <tbody>\r\n            <tr>\r\n              <td>Fuel Charges (30.00 AED per day × 25 days)</td>\r\n              <td class=\"text-right\">750.00</td>\r\n            </tr>\r\n          </tbody>\r\n        </table>\r\n      </div>\r\n\r\n      <div class=\"section\">\r\n        <div class=\"section-title\">SUMMARY</div>\r\n        <table>\r\n          <tbody>\r\n            <tr class=\"total-row\">\r\n              <td>TOTAL EXPENSES</td>\r\n              <td class=\"text-right\">${totalExpense.toFixed(2)}</td>\r\n            </tr>\r\n            ${\r\n              quotation\r\n                ? `\r\n              <tr>\r\n                <td>Project Quotation Amount</td>\r\n                <td class=\"text-right\">${quotationAmount.toFixed(2)}</td>\r\n              </tr>\r\n              <tr class=\"total-row\">\r\n                <td>${profit >= 0 ? \"PROFIT\" : \"LOSS\"}</td>\r\n                <td class=\"text-right\">${profit.toFixed(\r\n                  2\r\n                )} (${profitPercentage.toFixed(2)}%)</td>\r\n              </tr>\r\n            `\r\n                : \"\"\r\n            }\r\n          </tbody>\r\n        </table>\r\n      </div>\r\n    </body>\r\n    </html>\r\n    `;\r\n\r\n    // Generate PDF\r\n    const browser = await puppeteer.launch({\r\n      headless: \"shell\",\r\n      args: [\"--no-sandbox\", \"--disable-setuid-sandbox\"],\r\n    });\r\n\r\n    try {\r\n      const page = await browser.newPage();\r\n      await page.setContent(htmlContent, {\r\n        waitUntil: [\"load\", \"networkidle0\", \"domcontentloaded\"],\r\n        timeout: 30000,\r\n      });\r\n\r\n      const pdfBuffer = await page.pdf({\r\n        format: \"A4\",\r\n        printBackground: true,\r\n        margin: {\r\n          top: \"1cm\",\r\n          right: \"1cm\",\r\n          bottom: \"1cm\",\r\n          left: \"1cm\",\r\n        },\r\n      });\r\n\r\n      res.setHeader(\"Content-Type\", \"application/pdf\");\r\n      res.setHeader(\r\n        \"Content-Disposition\",\r\n        `attachment; filename=expense-report-${\r\n          (expense.project as IProject).projectNumber\r\n        }.pdf`\r\n      );\r\n      res.send(pdfBuffer);\r\n    } finally {\r\n      await browser.close();\r\n    }\r\n  }\r\n);\r\n"]}