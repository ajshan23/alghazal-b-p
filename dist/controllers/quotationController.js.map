{"version":3,"file":"quotationController.js","sourceRoot":"","sources":["../../src/controllers/quotationController.ts"],"names":[],"mappings":"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","sourcesContent":["import { Request, Response } from \"express\";\r\nimport { asyncHandler } from \"../utils/asyncHandler\";\r\nimport { ApiResponse } from \"../utils/apiHandlerHelpers\";\r\nimport { ApiError } from \"../utils/apiHandlerHelpers\";\r\nimport { Quotation } from \"../models/quotationModel\";\r\nimport { Project } from \"../models/projectModel\";\r\nimport { Estimation } from \"../models/estimationModel\";\r\nimport { uploadItemImage, deleteFileFromS3 } from \"../utils/uploadConf\";\r\nimport puppeteer from \"puppeteer\";\r\nimport { generateRelatedDocumentNumber } from \"../utils/documentNumbers\";\r\n\r\nexport const createQuotation = asyncHandler(\r\n  async (req: Request, res: Response) => {\r\n    // Debugging logs\r\n    console.log(\"Request body:\", req.body);\r\n    console.log(\"Request files:\", req.files);\r\n\r\n    if (!req.files || !Array.isArray(req.files)) {\r\n      throw new ApiError(400, \"No files were uploaded\");\r\n    }\r\n\r\n    // Parse the JSON data from form-data\r\n    let jsonData;\r\n    try {\r\n      jsonData = JSON.parse(req.body.data);\r\n    } catch (error) {\r\n      throw new ApiError(400, \"Invalid JSON data format\");\r\n    }\r\n\r\n    const {\r\n      project: projectId,\r\n      validUntil,\r\n      scopeOfWork = [],\r\n      items = [],\r\n      termsAndConditions = [],\r\n      vatPercentage = 5,\r\n    } = jsonData;\r\n\r\n    // Validate items is an array\r\n    if (!Array.isArray(items)) {\r\n      throw new ApiError(400, \"Items must be an array\");\r\n    }\r\n\r\n    // Check for existing quotation\r\n    const exists = await Quotation.findOne({ project: projectId });\r\n    if (exists) throw new ApiError(400, \"Project already has a quotation\");\r\n\r\n    const estimation = await Estimation.findOne({ project: projectId });\r\n    const estimationId = estimation?._id;\r\n\r\n    // Process items with their corresponding files\r\n    const processedItems = await Promise.all(\r\n      items.map(async (item: any, index: number) => {\r\n        // Find the image file for this item using the correct fieldname pattern\r\n        const imageFile = (req.files as Express.Multer.File[]).find(\r\n          (f) => f.fieldname === `items[${index}][image]`\r\n        );\r\n\r\n        if (imageFile) {\r\n          console.log(`Processing image for item ${index}:`, imageFile);\r\n          const uploadResult = await uploadItemImage(imageFile);\r\n          if (uploadResult.uploadData) {\r\n            item.image = uploadResult.uploadData;\r\n          }\r\n        } else {\r\n          console.log(`No image found for item ${index}`);\r\n        }\r\n\r\n        item.totalPrice = item.quantity * item.unitPrice;\r\n        return item;\r\n      })\r\n    );\r\n\r\n    // Calculate financial totals\r\n    const subtotal = processedItems.reduce(\r\n      (sum, item) => sum + item.totalPrice,\r\n      0\r\n    );\r\n    const vatAmount = subtotal * (vatPercentage / 100);\r\n    const total = subtotal + vatAmount;\r\n\r\n    const quotation = await Quotation.create({\r\n      project: projectId,\r\n      estimation: estimationId,\r\n      quotationNumber: await generateRelatedDocumentNumber(projectId, \"QTN\"),\r\n      date: new Date(),\r\n      validUntil: new Date(validUntil),\r\n      scopeOfWork,\r\n      items: processedItems,\r\n      termsAndConditions,\r\n      vatPercentage,\r\n      subtotal,\r\n      vatAmount,\r\n      netAmount: total,\r\n      preparedBy: req.user?.userId,\r\n    });\r\n\r\n    await Project.findByIdAndUpdate(projectId, { status: \"quotation_sent\" });\r\n\r\n    res.status(201).json(new ApiResponse(201, quotation, \"Quotation created\"));\r\n  }\r\n);\r\n\r\nexport const getQuotationByProject = asyncHandler(\r\n  async (req: Request, res: Response) => {\r\n    const { projectId } = req.params;\r\n    const quotation = await Quotation.findOne({ project: projectId })\r\n      .populate(\"project\", \"projectName\")\r\n      .populate(\"preparedBy\", \"firstName lastName\");\r\n\r\n    if (!quotation) throw new ApiError(404, \"Quotation not found\");\r\n    res\r\n      .status(200)\r\n      .json(new ApiResponse(200, quotation, \"Quotation retrieved\"));\r\n  }\r\n);\r\n\r\nexport const updateQuotation = asyncHandler(\r\n  async (req: Request, res: Response) => {\r\n    const { id } = req.params;\r\n    const { items, ...updateData } = req.body;\r\n\r\n    const quotation = await Quotation.findById(id);\r\n    if (!quotation) throw new ApiError(404, \"Quotation not found\");\r\n\r\n    if (items) {\r\n      quotation.items = await Promise.all(\r\n        items.map(async (item: any, index: number) => {\r\n          // Type the files object properly\r\n          const files = req.files as\r\n            | { [fieldname: string]: Express.Multer.File[] }\r\n            | undefined;\r\n          const fileKey = `items[${index}][image]`;\r\n\r\n          if (files?.[fileKey]?.[0]) {\r\n            // Delete old image if it exists\r\n            if (item.image?.key) {\r\n              await deleteFileFromS3(item.image.key);\r\n            }\r\n\r\n            // Upload new image\r\n            const uploadResult = await uploadItemImage(files[fileKey][0]);\r\n            if (uploadResult.uploadData) {\r\n              item.image = uploadResult.uploadData;\r\n            }\r\n          }\r\n\r\n          // Calculate total price\r\n          item.totalPrice = item.quantity * item.unitPrice;\r\n          return item;\r\n        })\r\n      );\r\n    }\r\n\r\n    Object.assign(quotation, updateData);\r\n    await quotation.save();\r\n\r\n    res.status(200).json(new ApiResponse(200, quotation, \"Quotation updated\"));\r\n  }\r\n);\r\n\r\nexport const approveQuotation = asyncHandler(\r\n  async (req: Request, res: Response) => {\r\n    const { id } = req.params;\r\n    const { isApproved, comment } = req.body;\r\n\r\n    const quotation = await Quotation.findByIdAndUpdate(\r\n      id,\r\n      {\r\n        isApproved,\r\n        approvalComment: comment,\r\n        approvedBy: req.user?.userId,\r\n      },\r\n      { new: true }\r\n    );\r\n\r\n    await Project.findByIdAndUpdate(quotation?.project, {\r\n      status: isApproved ? \"quotation_approved\" : \"quotation_rejected\",\r\n    });\r\n\r\n    res\r\n      .status(200)\r\n      .json(\r\n        new ApiResponse(\r\n          200,\r\n          quotation,\r\n          `Quotation ${isApproved ? \"approved\" : \"rejected\"}`\r\n        )\r\n      );\r\n  }\r\n);\r\n\r\nexport const deleteQuotation = asyncHandler(\r\n  async (req: Request, res: Response) => {\r\n    const { id } = req.params;\r\n    const quotation = await Quotation.findByIdAndDelete(id);\r\n\r\n    if (!quotation) throw new ApiError(404, \"Quotation not found\");\r\n\r\n    await Promise.all(\r\n      quotation.items.map((item) =>\r\n        item.image?.key ? deleteFileFromS3(item.image.key) : Promise.resolve()\r\n      )\r\n    );\r\n\r\n    await Project.findByIdAndUpdate(quotation.project, {\r\n      status: \"estimation_prepared\",\r\n    });\r\n\r\n    res.status(200).json(new ApiResponse(200, null, \"Quotation deleted\"));\r\n  }\r\n);\r\n\r\nexport const generateQuotationPdf = asyncHandler(\r\n  async (req: Request, res: Response) => {\r\n    const { id } = req.params;\r\n\r\n    // Populate all necessary fields\r\n    const quotation = await Quotation.findById(id)\r\n      .populate({\r\n        path: \"project\",\r\n        select: \"projectName client siteAddress\",\r\n        populate: {\r\n          path: \"client\",\r\n          select: \"clientName clientAddress mobileNumber telephoneNumber email\",\r\n        },\r\n      })\r\n      .populate(\"preparedBy\", \"firstName lastName signatureImage\")\r\n      .populate(\"approvedBy\", \"firstName lastName signatureImage\");\r\n\r\n    if (!quotation) throw new ApiError(404, \"Quotation not found\");\r\n\r\n    // Verify populated data exists\r\n    if (!quotation.project || !quotation.project.client) {\r\n      throw new ApiError(400, \"Client information not found\");\r\n    }\r\n\r\n    // Calculate totals (though they should be pre-calculated by the pre-save hook)\r\n    const subtotal = quotation.items.reduce(\r\n      (sum, item) => sum + item.totalPrice,\r\n      0\r\n    );\r\n    const vatAmount = subtotal * (quotation.vatPercentage / 100);\r\n    const netAmount = subtotal + vatAmount;\r\n\r\n    // Format dates\r\n    const formatDate = (date: Date) => {\r\n      return date ? new Date(date).toLocaleDateString(\"en-GB\") : \"\";\r\n    };\r\n\r\n    const preparedBy = quotation.preparedBy;\r\n    // const approvedBy = quotation.approvedBy;\r\n    const estimationId = quotation.estimation;\r\n    const estimation = await Estimation.findById(estimationId)\r\n      .populate(\"approvedBy\", \"firstName lastName signatureImage\")\r\n      .populate(\"preparedBy\", \"firstName lastName signatureImage\");\r\n    const approvedBy = estimation.approvedBy;\r\n    // const approvedBy = estimation.approvedBy;\r\n    console.log(\"Approved By:\", approvedBy);\r\n\r\n    // Prepare HTML content\r\n    let htmlContent = `\r\n    <!DOCTYPE html PUBLIC \"\">\r\n    <html xmlns=\"\" xml:lang=\"en\" lang=\"en\">\r\n      <head>\r\n        <meta http-equiv=\"Content-Type\" content=\"text/html; charset=utf-8\" />\r\n        <title></title>\r\n        <style type=\"text/css\">\r\n          * {\r\n            margin: 0;\r\n            padding: 0;\r\n            text-indent: 0;\r\n          }\r\n          .s1 {\r\n            color: black;\r\n            font-family: Cambria, serif;\r\n            font-style: normal;\r\n            font-weight: bold;\r\n            text-decoration: none;\r\n            font-size: 11.5pt;\r\n          }\r\n          .s2 {\r\n            color: black;\r\n            font-family: Cambria, serif;\r\n            font-style: normal;\r\n            font-weight: bold;\r\n            text-decoration: none;\r\n            font-size: 10.5pt;\r\n          }\r\n          .s3 {\r\n            color: black;\r\n            font-family: Cambria, serif;\r\n            font-style: normal;\r\n            font-weight: normal;\r\n            text-decoration: none;\r\n            font-size: 10pt;\r\n          }\r\n          .s4 {\r\n            color: black;\r\n            font-family: Cambria, serif;\r\n            font-style: normal;\r\n            font-weight: bold;\r\n            text-decoration: none;\r\n            font-size: 10pt;\r\n          }\r\n          .s5 {\r\n            color: black;\r\n            font-family: Cambria, serif;\r\n            font-style: normal;\r\n            font-weight: normal;\r\n            text-decoration: none;\r\n            font-size: 10.5pt;\r\n          }\r\n          .s6 {\r\n            color: black;\r\n            font-family: Cambria, serif;\r\n            font-style: normal;\r\n            font-weight: normal;\r\n            text-decoration: none;\r\n            font-size: 11.5pt;\r\n          }\r\n          .s7 {\r\n            color: #0562c1;\r\n            font-family: Cambria, serif;\r\n            font-style: normal;\r\n            font-weight: normal;\r\n            text-decoration: underline;\r\n            font-size: 10.5pt;\r\n          }\r\n          table,\r\n          tbody {\r\n            vertical-align: top;\r\n            overflow: visible;\r\n          }\r\n        </style>\r\n      </head>\r\n      <body>\r\n        <table style=\"border-collapse: collapse; margin-left: 6.425pt\" cellspacing=\"0\">\r\n          <tr style=\"height: 126pt\">\r\n            <td style=\"width: 560pt; border-left-style: solid; border-left-width: 2pt; border-bottom-style: solid; border-bottom-width: 2pt; border-right-style: solid; border-right-width: 2pt;  border-top-style: solid;\r\n            border-top-width: 2pt;\" colspan=\"7\">\r\n              <p style=\"text-indent: 0pt; text-align: left\">\r\n                <span><table border=\"0\" cellspacing=\"0\" cellpadding=\"0\">\r\n                    <tr>\r\n                      <img src=\"https://krishnadas-test-1.s3.ap-south-1.amazonaws.com/alghazal/logo.png\" alt=\"\" style=\"width:100%\" />\r\n                    </tr>\r\n                  </table></span>\r\n              </p>\r\n              <p class=\"s1\" style=\"padding-left: 2pt; text-indent: 0pt; line-height: 13pt; text-align: center;\">\r\n                QUOTATION\r\n              </p>\r\n            </td>\r\n          </tr>\r\n          <tr style=\"height: 13pt\">\r\n            <td style=\"width: 367pt; border-top-style: solid; border-top-width: 2pt; border-left-style: solid; border-left-width: 2pt; border-bottom-style: solid; border-bottom-width: 2pt; border-right-style: solid; border-right-width: 1pt;\" colspan=\"5\">\r\n              <p class=\"s2\" style=\"padding-left: 2pt; text-indent: 0pt; line-height: 12pt; text-align: center;\">\r\n                Name/Address\r\n              </p>\r\n            </td>\r\n            <td style=\"width: 63pt; border-top-style: solid; border-top-width: 2pt; border-left-style: solid; border-left-width: 1pt; border-bottom-style: solid; border-bottom-width: 2pt; border-right-style: solid; border-right-width: 1pt;\">\r\n              <p class=\"s2\" style=\"padding-left: 3pt; text-indent: 0pt; line-height: 12pt; text-align: center;\">\r\n                Date\r\n              </p>\r\n            </td>\r\n            <td style=\"width: 130pt; border-top-style: solid; border-top-width: 2pt; border-left-style: solid; border-left-width: 1pt; border-bottom-style: solid; border-bottom-width: 2pt; border-right-style: solid; border-right-width: 2pt;\">\r\n              <p class=\"s2\" style=\"padding-left: 3pt; text-indent: 0pt; line-height: 12pt; text-align: center;\">\r\n                Quotation#\r\n              </p>\r\n            </td>\r\n          </tr>\r\n          <tr style=\"height: 50pt\">\r\n            <td style=\"width: 367pt; border-top-style: solid; border-top-width: 2pt; border-left-style: solid; border-left-width: 2pt; border-bottom-style: solid; border-bottom-width: 2pt; border-right-style: solid; border-right-width: 2pt;\" colspan=\"5\" rowspan=\"2\">\r\n              <p class=\"s2\" style=\"padding-left: 1pt; text-indent: 0pt; line-height: 12pt; text-align: left;\">\r\n                ${quotation.project.client.clientName || \"N/A\"}\r\n              </p>\r\n              <p class=\"s2\" style=\"padding-top: 1pt; padding-left: 1pt; text-indent: 0pt; text-align: left;\">\r\n                ${quotation.project.client.clientAddress || \"N/A\"}\r\n              </p>\r\n              <p class=\"s2\" style=\"padding-top: 1pt; padding-left: 1pt; text-indent: 0pt; text-align: left;\">\r\n                Tel : ${\r\n                  quotation.project.client.mobileNumber ||\r\n                  quotation.project.client.telephoneNumber ||\r\n                  \"N/A\"\r\n                }\r\n              </p>\r\n              <p class=\"s2\" style=\"padding-top: 1pt; padding-left: 1pt; text-indent: 0pt; text-align: left;\">\r\n                Email: ${quotation.project.client.email || \"N/A\"}\r\n              </p>\r\n              <p class=\"s2\" style=\"padding-top: 1pt; padding-left: 1pt; text-indent: 0pt; text-align: left;\">\r\n                Site: ${quotation.project.siteAddress || \"N/A\"}\r\n              </p>\r\n            </td>\r\n            <td style=\"width: 63pt; border-top-style: solid; border-top-width: 2pt; border-left-style: solid; border-left-width: 2pt; border-bottom-style: solid; border-bottom-width: 1pt; border-right-style: solid; border-right-width: 1pt;\">\r\n              <p style=\"padding-top: 6pt; text-indent: 0pt; text-align: left\"><br /></p>\r\n              <p class=\"s2\" style=\"padding-left: 2pt; text-indent: 0pt; text-align: center\">\r\n                ${formatDate(quotation.date)}\r\n              </p>\r\n            </td>\r\n            <td style=\"width: 130pt; border-top-style: solid; border-top-width: 2pt; border-left-style: solid; border-left-width: 1pt; border-bottom-style: solid; border-bottom-width: 1pt; border-right-style: solid; border-right-width: 2pt;\">\r\n              <p style=\"padding-top: 6pt; text-indent: 0pt; text-align: left\"><br /></p>\r\n              <p class=\"s2\" style=\"padding-left: 3pt; padding-right: 1pt; text-indent: 0pt; text-align: center;\">\r\n                ${quotation.quotationNumber}\r\n              </p>\r\n            </td>\r\n          </tr>\r\n          <tr style=\"height: 23pt\">\r\n            <td style=\"width: 63pt; border-top-style: solid; border-top-width: 1pt; border-left-style: solid; border-left-width: 2pt; border-bottom-style: solid; border-bottom-width: 1pt; border-right-style: solid; border-right-width: 1pt;\">\r\n              <p class=\"s2\" style=\"padding-top: 4pt; padding-left: 2pt; text-indent: 0pt; text-align: center;\">\r\n                VALIDITY\r\n              </p>\r\n            </td>\r\n            <td style=\"width: 130pt; border-top-style: solid; border-top-width: 1pt; border-left-style: solid; border-left-width: 1pt; border-bottom-style: solid; border-bottom-width: 1pt; border-right-style: solid; border-right-width: 2pt;\">\r\n              <p class=\"s2\" style=\"padding-top: 4pt; padding-left: 3pt; text-indent: 0pt; text-align: center;\">\r\n                ${formatDate(quotation.validUntil)}\r\n              </p>\r\n            </td>\r\n          </tr>\r\n          <tr style=\"height: 42pt\">\r\n            <td style=\"width: 560pt; border-top-style: solid; border-top-width: 2pt; border-left-style: solid; border-left-width: 2pt; border-bottom-style: solid; border-bottom-width: 1pt; border-right-style: solid; border-right-width: 2pt;\" colspan=\"7\">\r\n              <p class=\"s2\" style=\"padding-top: 7pt; padding-left: 1pt; text-indent: 2pt; line-height: 107%; text-align: left;\">\r\n                SUB: <span class=\"s3\">${\r\n                  quotation.project.projectName || \"N/A\"\r\n                }</span>\r\n              </p>\r\n            </td>\r\n          </tr>\r\n          <tr style=\"height: 19pt\">\r\n  <td style=\"width: 30pt; border-top-style: solid; border-top-width: 1pt; border-left-style: solid; border-left-width: 2pt; border-bottom-style: solid; border-bottom-width: 1pt; border-right-style: solid; border-right-width: 1pt;\">\r\n    <p class=\"s4\" style=\"padding-top: 3pt; padding-left: 2pt; text-indent: 0pt; text-align: center;\">\r\n      SL.NO\r\n    </p>\r\n  </td>\r\n  <td style=\"width: 180pt; border-top-style: solid; border-top-width: 1pt; border-left-style: solid; border-left-width: 1pt; border-bottom-style: solid; border-bottom-width: 1pt; border-right-style: solid; border-right-width: 1pt;\">\r\n    <p class=\"s4\" style=\"padding-top: 3pt; padding-left: 2pt; text-indent: 0pt; text-align: center;\">\r\n      DESCRIPTION\r\n    </p>\r\n  </td>\r\n  <td style=\"width: 30pt; border-top-style: solid; border-top-width: 1pt; border-left-style: solid; border-left-width: 1pt; border-bottom-style: solid; border-bottom-width: 1pt; border-right-style: solid; border-right-width: 1pt;\">\r\n    <p class=\"s4\" style=\"padding-top: 3pt; text-indent: 0pt; text-align: center;\">\r\n      UOM\r\n    </p>\r\n  </td>\r\n  <td style=\"width: 50pt; border-top-style: solid; border-top-width: 1pt; border-left-style: solid; border-left-width: 1pt; border-bottom-style: solid; border-bottom-width: 1pt; border-right-style: solid; border-right-width: 1pt;\">\r\n    <p class=\"s4\" style=\"padding-top: 3pt; text-indent: 0pt; text-align: center;\">\r\n      IMAGE\r\n    </p>\r\n  </td>\r\n  <td style=\"width: 40pt; border-top-style: solid; border-top-width: 1pt; border-left-style: solid; border-left-width: 1pt; border-bottom-style: solid; border-bottom-width: 1pt; border-right-style: solid; border-right-width: 1pt;\">\r\n    <p class=\"s4\" style=\"padding-top: 3pt; text-indent: 0pt; text-align: center;\">\r\n      QTY\r\n    </p>\r\n  </td>\r\n  <td style=\"width: 50pt; border-top-style: solid; border-top-width: 1pt; border-left-style: solid; border-left-width: 1pt; border-bottom-style: solid; border-bottom-width: 1pt; border-right-style: solid; border-right-width: 1pt;\">\r\n    <p class=\"s4\" style=\"padding-top: 3pt; text-indent: 0pt; text-align: center;\">\r\n      UNIT PRICE\r\n    </p>\r\n  </td>\r\n  <td style=\"width: 60pt; border-top-style: solid; border-top-width: 1pt; border-left-style: solid; border-left-width: 1pt; border-bottom-style: solid; border-bottom-width: 1pt; border-right-style: solid; border-right-width: 2pt;\">\r\n    <p class=\"s4\" style=\"padding-top: 3pt; text-indent: 0pt; text-align: center;\">\r\n      TOTAL\r\n    </p>\r\n  </td>\r\n</tr>\r\n\r\n${quotation.items\r\n  .map(\r\n    (item, index) => `\r\n<tr style=\"height: 50pt\">\r\n  <td style=\"width: 30pt; border-top-style: solid; border-top-width: 1pt; border-left-style: solid; border-left-width: 2pt; border-bottom-style: solid; border-bottom-width: 1pt; border-right-style: solid; border-right-width: 1pt;\">\r\n    <p class=\"s5\" style=\"padding-top: 6pt; text-indent: 0pt; text-align: center\">\r\n      ${index + 1}\r\n    </p>\r\n  </td>\r\n  <td style=\"width: 180pt; border-top-style: solid; border-top-width: 1pt; border-left-style: solid; border-left-width: 1pt; border-bottom-style: solid; border-bottom-width: 1pt; border-right-style: solid; border-right-width: 1pt;\">\r\n    <p class=\"s5\" style=\"padding-top: 6pt; padding-left: 2pt; text-indent: 0pt; text-align: left\">\r\n      ${item.description}\r\n    </p>\r\n  </td>\r\n  <td style=\"width: 30pt; border-top-style: solid; border-top-width: 1pt; border-left-style: solid; border-left-width: 1pt; border-bottom-style: solid; border-bottom-width: 1pt; border-right-style: solid; border-right-width: 1pt;\">\r\n    <p class=\"s5\" style=\"padding-top: 6pt; text-indent: 0pt; text-align: center\">\r\n      ${item.uom || \"NOS\"}\r\n    </p>\r\n  </td>\r\n  <td style=\"width: 50pt; border-top-style: solid; border-top-width: 1pt; border-left-style: solid; border-left-width: 1pt; border-bottom-style: solid; border-bottom-width: 1pt; border-right-style: solid; border-right-width: 1pt;\">\r\n    <div style=\"width: 40pt; height: 40pt; display: flex; align-items: center; justify-content: center; margin: 0 auto;\">\r\n      ${\r\n        item.image?.url\r\n          ? `<img src=\"${item.image.url}\" style=\"max-width: 100%; max-height: 100%; object-fit: contain;\"/>`\r\n          : \"\"\r\n      }\r\n    </div>\r\n  </td>\r\n  <td style=\"width: 40pt; border-top-style: solid; border-top-width: 1pt; border-left-style: solid; border-left-width: 1pt; border-bottom-style: solid; border-bottom-width: 1pt; border-right-style: solid; border-right-width: 1pt;\">\r\n    <p class=\"s5\" style=\"padding-top: 6pt; text-indent: 0pt; text-align: center\">\r\n      ${item.quantity.toFixed(2)}\r\n    </p>\r\n  </td>\r\n  <td style=\"width: 50pt; border-top-style: solid; border-top-width: 1pt; border-left-style: solid; border-left-width: 1pt; border-bottom-style: solid; border-bottom-width: 1pt; border-right-style: solid; border-right-width: 1pt;\">\r\n    <p class=\"s5\" style=\"padding-top: 6pt; text-indent: 0pt; text-align: center\">\r\n      ${item.unitPrice.toFixed(2)}\r\n    </p>\r\n  </td>\r\n  <td style=\"width: 60pt; border-top-style: solid; border-top-width: 1pt; border-left-style: solid; border-left-width: 1pt; border-bottom-style: solid; border-bottom-width: 1pt; border-right-style: solid; border-right-width: 2pt;\">\r\n    <p class=\"s2\" style=\"padding-top: 6pt; text-indent: 0pt; text-align: center\">\r\n      ${item.totalPrice.toFixed(2)}\r\n    </p>\r\n  </td>\r\n</tr>\r\n`\r\n  )\r\n  .join(\"\")}\r\n          <tr style=\"height: 19pt\">\r\n            <td style=\"width: 430pt; border-top-style: solid; border-top-width: 1pt; border-left-style: solid; border-left-width: 2pt; border-bottom-style: solid; border-bottom-width: 1pt; border-right-style: solid; border-right-width: 1pt;\" colspan=\"6\">\r\n              <p class=\"s2\" style=\"padding-top: 2pt; padding-right: 8pt; text-indent: 0pt; text-align: right;\">\r\n                TOTAL AMOUNT\r\n              </p>\r\n            </td>\r\n            <td style=\"width: 130pt; border-top-style: solid; border-top-width: 1pt; border-left-style: solid; border-left-width: 1pt; border-bottom-style: solid; border-bottom-width: 1pt; border-right-style: solid; border-right-width: 2pt;\">\r\n              <p class=\"s2\" style=\"padding-top: 3pt; padding-left: 3pt; text-indent: 0pt; text-align: center;\">\r\n                ${subtotal.toFixed(2)}\r\n              </p>\r\n            </td>\r\n          </tr>\r\n          <tr style=\"height: 19pt\">\r\n            <td style=\"width: 430pt; border-top-style: solid; border-top-width: 1pt; border-left-style: solid; border-left-width: 2pt; border-bottom-style: solid; border-bottom-width: 1pt; border-right-style: solid; border-right-width: 1pt;\" colspan=6\">\r\n              <p class=\"s2\" style=\"padding-top: 2pt; padding-right: 8pt; text-indent: 0pt; text-align: right;\">\r\n                VAT ${quotation.vatPercentage}%\r\n              </p>\r\n            </td>\r\n            <td style=\"width: 130pt; border-top-style: solid; border-top-width: 1pt; border-left-style: solid; border-left-width: 1pt; border-bottom-style: solid; border-bottom-width: 1pt; border-right-style: solid; border-right-width: 2pt;\">\r\n              <p class=\"s2\" style=\"padding-top: 3pt; padding-left: 3pt; text-indent: 0pt; text-align: center;\">\r\n                ${vatAmount.toFixed(2)}\r\n              </p>\r\n            </td>\r\n          </tr>\r\n          <tr style=\"height: 19pt\">\r\n            <td style=\"width: 430pt; border-top-style: solid; border-top-width: 1pt; border-left-style: solid; border-left-width: 2pt; border-bottom-style: solid; border-bottom-width: 1pt; border-right-style: solid; border-right-width: 1pt;\" colspan=\"6\">\r\n              <p style=\"text-indent: 0pt; text-align: left\">\r\n                <span><table border=\"0\" cellspacing=\"0\" cellpadding=\"0\"></table></span>\r\n              </p>\r\n              <p class=\"s2\" style=\"padding-top: 2pt; padding-right: 8pt; text-indent: 0pt; text-align: right;\">\r\n                NET AMOUNT\r\n              </p>\r\n            </td>\r\n            <td style=\"width: 130pt; border-top-style: solid; border-top-width: 1pt; border-left-style: solid; border-left-width: 1pt; border-bottom-style: solid; border-bottom-width: 1pt; border-right-style: solid; border-right-width: 2pt;\">\r\n              <p class=\"s2\" style=\"padding-top: 3pt; padding-left: 3pt; text-indent: 0pt; text-align: center;\">\r\n                ${netAmount.toFixed(2)}\r\n              </p>\r\n            </td>\r\n          </tr>\r\n          ${quotation.termsAndConditions\r\n            .map(\r\n              (term, index) => `\r\n            <tr style=\"height: 17pt\">\r\n              <td style=\"width: 560pt; border-top-style: solid; border-top-width: 1pt; border-left-style: solid; border-left-width: 2pt; border-bottom-style: solid; border-bottom-width: ${\r\n                index === quotation.termsAndConditions.length - 1\r\n                  ? \"2pt\"\r\n                  : \"1pt\"\r\n              }; border-right-style: solid; border-right-width: 2pt;\" colspan=\"7\">\r\n                <p class=\"s6\" style=\"padding-top: 1pt; padding-left: 1pt; text-indent: 0pt; text-align: left;\">\r\n                  ${index + 1}. ${term}\r\n                </p>\r\n              </td>\r\n            </tr>\r\n          `\r\n            )\r\n            .join(\"\")}\r\n          <tr style=\"height: 13pt\">\r\n            <td style=\"width: 309pt; border-top-style: solid; border-top-width: 1pt; border-left-style: solid; border-left-width: 2pt; border-bottom-style: solid; border-bottom-width: 1pt; border-right-style: solid; border-right-width: 1pt;\" colspan=\"4\">\r\n              <p class=\"s4\" style=\"padding-left: 1pt; text-indent: 0pt; line-height: 11pt; text-align: left;\">\r\n                FOR AL GHAZAL AL ABYAD TECHNICAL SERVICES\r\n              </p>\r\n            </td>\r\n            <td style=\"width: 121pt; border-top-style: solid; border-top-width: 1pt; border-left-style: solid; border-left-width: 1pt; border-bottom-style: solid; border-bottom-width: 2pt; border-right-style: solid; border-right-width: 1pt;\" colspan=\"2\" rowspan=\"6\">\r\n              <img src=\"https://krishnadas-test-1.s3.ap-south-1.amazonaws.com/alghazal/seal.png\" alt=\"\" style=\"width: 100%; height: auto;\">\r\n            </td>\r\n            <td style=\"width: 130pt; border-top-style: solid; border-top-width: 1pt; border-left-style: solid; border-left-width: 1pt; border-bottom-style: solid; border-bottom-width: 1pt; border-right-style: solid; border-right-width: 2pt;\">\r\n              <p style=\"text-indent: 0pt; text-align: left\"><br /></p>\r\n            </td>\r\n          </tr>\r\n          <tr style=\"height: 13pt\">\r\n            <td style=\"width: 102pt; border-top-style: solid; border-top-width: 1pt; border-left-style: solid; border-left-width: 2pt; border-bottom-style: solid; border-bottom-width: 1pt; border-right-style: solid; border-right-width: 1pt;\" colspan=\"3\">\r\n              <p class=\"s4\" style=\"padding-left: 1pt; text-indent: 0pt; line-height: 11pt; text-align: left;\">\r\n                Prepared by\r\n              </p>\r\n            </td>\r\n            <td style=\"width: 207pt; border-top-style: solid; border-top-width: 1pt; border-left-style: solid; border-left-width: 1pt; border-bottom-style: solid; border-bottom-width: 1pt; border-right-style: solid; border-right-width: 1pt;\">\r\n              <p class=\"s2\" style=\"padding-left: 2pt; text-indent: 0pt; line-height: 11pt; text-align: left;\">\r\n                ${preparedBy?.firstName || \"N/A\"} ${preparedBy?.lastName || \"\"}\r\n              </p>\r\n            </td>\r\n            <td style=\"width: 130pt; border-top-style: solid; border-top-width: 1pt; border-left-style: solid; border-left-width: 1pt; border-bottom-style: solid; border-bottom-width: 1pt; border-right-style: solid; border-right-width: 2pt;\" rowspan=\"3\">\r\n              <p style=\"text-indent: 0pt; text-align: left\"><br /></p>\r\n              <p style=\"padding-left: 46pt; text-indent: 0pt; text-align: left\">\r\n                <span><table border=\"0\" cellspacing=\"0\" cellpadding=\"0\">\r\n                    <tr>\r\n                      <td>\r\n                        ${\r\n                          approvedBy?.signatureImage\r\n                            ? `\r\n                        <img\r\n                          width=\"81\"\r\n                          height=\"34\"\r\n                          src=\"${approvedBy.signatureImage}\"\r\n                        />`\r\n                            : \"\"\r\n                        }\r\n                      </td>\r\n                    </tr></table>\r\n                </span>\r\n              </p>\r\n            </td>\r\n          </tr>\r\n          <tr style=\"height: 13pt\">\r\n            <td style=\"width: 309pt; border-top-style: solid; border-top-width: 1pt; border-left-style: solid; border-left-width: 2pt; border-bottom-style: solid; border-bottom-width: 1pt; border-right-style: solid; border-right-width: 1pt;\" colspan=\"4\">\r\n              <p class=\"s4\" style=\"padding-left: 1pt; text-indent: 0pt; line-height: 11pt; text-align: left;\">\r\n                CONTACT: 044102555 / Mob.No: 0588475758\r\n              </p>\r\n            </td>\r\n          </tr>\r\n          <tr style=\"height: 13pt\">\r\n            <td style=\"width: 309pt; border-top-style: solid; border-top-width: 1pt; border-left-style: solid; border-left-width: 2pt; border-bottom-style: solid; border-bottom-width: 1pt; border-right-style: solid; border-right-width: 1pt;\" colspan=\"4\">\r\n              <p class=\"s4\" style=\"padding-left: 1pt; text-indent: 0pt; line-height: 11pt; text-align: left;\">\r\n                Shop No:04,R09-France Cluster,International City-Dubai\r\n              </p>\r\n            </td>\r\n          </tr>\r\n          <tr style=\"height: 13pt\">\r\n            <td style=\"width: 309pt; border-top-style: solid; border-top-width: 1pt; border-left-style: solid; border-left-width: 2pt; border-bottom-style: solid; border-bottom-width: 1pt; border-right-style: solid; border-right-width: 1pt;\" colspan=\"4\">\r\n              <p class=\"s4\" style=\"padding-left: 1pt; text-indent: 0pt; line-height: 11pt; text-align: left;\">\r\n                P.O.Box:262760,Dubai-U.A.E\r\n              </p>\r\n            </td>\r\n            <td style=\"width: 130pt; border-top-style: solid; border-top-width: 1pt; border-left-style: solid; border-left-width: 1pt; border-bottom-style: solid; border-bottom-width: 1pt; border-right-style: solid; border-right-width: 2pt;\">\r\n              <p style=\"text-indent: 0pt; text-align: left\"><br /></p>\r\n            </td>\r\n          </tr>\r\n          <tr style=\"height: 15pt\">\r\n            <td style=\"width: 309pt; border-top-style: solid; border-top-width: 1pt; border-left-style: solid; border-left-width: 2pt; border-bottom-style: solid; border-bottom-width: 2pt; border-right-style: solid; border-right-width: 1pt;\" colspan=\"4\">\r\n              <p style=\"padding-left: 1pt; text-indent: 0pt; line-height: 12pt; text-align: left;\">\r\n                <a href=\"http://www.alghazalgroup.com/\" class=\"s7\">www.alghazalgroup.com</a>\r\n              </p>\r\n            </td>\r\n            <td style=\"width: 130pt; border-top-style: solid; border-top-width: 1pt; border-left-style: solid; border-left-width: 1pt; border-bottom-style: solid; border-bottom-width: 2pt; border-right-style: solid; border-right-width: 2pt;\">\r\n              <p style=\"text-indent: 0pt; text-align: left\"><br /></p>\r\n            </td>\r\n          </tr>\r\n        </table>\r\n      </body>\r\n    </html>\r\n    `;\r\n\r\n    // Generate PDF\r\n    const browser = await puppeteer.launch({\r\n      headless: \"new\",\r\n      args: [\"--no-sandbox\", \"--disable-setuid-sandbox\"],\r\n    });\r\n\r\n    try {\r\n      const page = await browser.newPage();\r\n\r\n      await page.setViewport({\r\n        width: 1200,\r\n        height: 1800,\r\n        deviceScaleFactor: 1,\r\n      });\r\n\r\n      await page.setContent(htmlContent, {\r\n        waitUntil: [\"load\", \"networkidle0\", \"domcontentloaded\"],\r\n        timeout: 30000,\r\n      });\r\n\r\n      // Additional wait for dynamic content\r\n      await page.waitForSelector(\"body\", { timeout: 5000 });\r\n\r\n      const pdfBuffer = await page.pdf({\r\n        format: \"A4\",\r\n        printBackground: true,\r\n        margin: {\r\n          top: \"0.5in\",\r\n          right: \"0.5in\",\r\n          bottom: \"0.5in\",\r\n          left: \"0.5in\",\r\n        },\r\n        preferCSSPageSize: true,\r\n      });\r\n\r\n      res.setHeader(\"Content-Type\", \"application/pdf\");\r\n      res.setHeader(\r\n        \"Content-Disposition\",\r\n        `attachment; filename=quotation-${quotation.quotationNumber}.pdf`\r\n      );\r\n      res.send(pdfBuffer);\r\n    } finally {\r\n      await browser.close();\r\n    }\r\n  }\r\n);\r\n"]}